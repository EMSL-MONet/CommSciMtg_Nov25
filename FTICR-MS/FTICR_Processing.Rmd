---
title: "FTICR_Monet_Processing"
date: "2025-04-06"
output: 
  html_document:
    keep_md: yes
    code_folding: hide
---

``` {r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```



```{r setup2, include=FALSE}

library(tidyverse)
theme_set(theme_bw(base_size = 14))

```

## R Markdown

#### Import and combine data

```{r import}

## Each sample has 3 replicates, compressed in a single zip file.
## This script will extract all the zip files in the target folder (creating temporary files) and import and combine them into a single dataframe.
## Finally, we will delete the temporary files.

import_files = function(FILEPATH){

  # identify the .zip files and unzip them as csv files
  # the csv files will be saved in the parent directory (these are temporary files, will be deleted at the end)
  zip_filePaths <- list.files(path = FILEPATH, pattern = ".zip", full.names = TRUE, recursive = TRUE)
  zip_filePaths %>% lapply(unzip)
  
  # now, identify all the fticrWEOM csv files that we just extracted 
  csv_filePaths <- list.files(pattern = "fticrWEOM", full.names = TRUE)
  
  # read and combine the fticrWEOM csv files
  icr_dat <- do.call(bind_rows, lapply(csv_filePaths, function(path) {
    
    data = read.csv(path) %>% 
      mutate(source = basename(path)) # add file name
    
  }))
  
  # finally, delete the temporary files from the parent directory
  file.remove(csv_filePaths)

  # this is our final output
  icr_dat
}

icr_report = import_files("FTICR-MS/FTICR_Processing_data")
```


This contains a lot of info -- we do not need all these columns!

Step 1 is to split this file into two: (a) `mol` file, which has info for each molecule/peak; and (b) `dat` file, which has data about the samples


#### Create molecular metadata file

```{r}

mol = 
  icr_report %>% 
  dplyr::select(`Molecular.Formula`, C,H,O,N,P,S) %>% 
  rename(molecular_formula = `Molecular.Formula`) %>% 
  distinct()

```

Now, we want to process the `mol` file and calculate a bunch of indices


(a) indices

```{r}

mol = 
  mol %>% 
  mutate(across(c("N","S","P"), ~replace_na(.,0)),
         AImod = round((1 + C - (0.5*O) - S - (0.5 * (N+P+H)))/(C - (0.5*O) - S - N - P), 4),
         NOSC =  round(4-(((4*C) + H - (3*N) - (2*O) - (2*S))/C), 4),
         GFE = 60.3-(28.5 * NOSC),
         AImod = ifelse(is.na(AImod), 0, AImod),
         AImod = ifelse(AImod == "Inf", 0, AImod),
         AImod = ifelse(AImod == "-Inf", 0, AImod),
         HC = round(H/C, 2),
         OC = round(O/C, 2)
  )

```

(b) Elemental class

```{r}
mol = 
  mol %>% 
  mutate(
    El = str_remove_all(molecular_formula, "[0-9]"),
    El = str_remove_all(El, " "))

```

(c) molecular class

```{r}
mol = 
  mol %>% 
  mutate(
    Class1 = case_when(HC >= 1.55 & HC <= 2.25 & OC >= 0 & OC <= 0.3 ~ "Lipid",
                       HC >= 0.7 & HC <= 1.5 & OC >= 0.05 & OC <= 0.15 ~ "Unsat Hydrocarbon",
                       HC >= 1.45 & HC <= 2 & OC >= 0.3 & OC <= 0.55 ~ "Protein",
                       HC >= 0.81 & HC <= 1.45 & OC >= 0.28 & OC <= 0.65 ~ "Lignin",
                       HC >= 1.48 & HC <= 2.15 & OC >= 0.68 & OC <= 1 ~ "Carbohydrate",
                       HC >= 1.34 & HC <= 1.8 & OC >= 0.54 & OC <= 0.71 ~ "Amino Sugar",
                       HC >= 0.7 & HC <= 1.3 & OC >= 0.65 & OC <= 1.05 ~ "Tannin",
                       HC >= 0.3 & HC <= 0.81 & OC >= 0.12 & OC <= 0.7 ~ "Cond Hydrocarbon",
                       TRUE ~ "Other"),
    Class2 = case_when(AImod > 0.66 ~ "condensed aromatic",
                       AImod <= 0.66 & AImod > 0.50 ~ "aromatic",
                       AImod <= 0.50 & HC < 1.5 ~ "unsaturated/lignin",
                       HC >= 1.5 ~ "aliphatic"),
    Class2 = replace_na(Class2, "other"),
    Class3 = case_when(AImod > 0.66 ~ "condensed aromatic",
                       AImod <= 0.66 & AImod > 0.50 ~ "aromatic",
                       AImod <= 0.50 & HC < 1.5 ~ "unsaturated/lignin",
                       HC >= 2.0 & OC >= 0.9 ~ "carbohydrate",
                       HC >= 2.0 & OC < 0.9 ~ "lipid",
                       HC < 2.0 & HC >= 1.5 & N == 0 ~ "aliphatic",
                       HC < 2.0 & HC >= 1.5 & N > 0 ~ "aliphatic+N")
  )
         
```


this file now contains most of the info needed to interpret the data across different samples.

---

#### Create `dat` file

```{r}

dat = 
  icr_report %>% 
  dplyr::select(source, Molecular.Formula, Calculated.m.z, contains("Peak.Area")) %>% 
  janitor::clean_names() %>% 
  separate(source, sep = "_", into = c("icr", "Proposal_ID", "Sampling_Set", "Core_Section", "Rep")) %>% 
  mutate(Rep = parse_number(Rep),
         sample_name = paste0(Proposal_ID, "_", Sampling_Set, "_", Core_Section)) %>% 
  dplyr::select(-icr)


```




#### 3 acquisitions

```{r}
## acquisition reps

dat_acq = 
  dat %>% 
  mutate(peak_area_1 = case_when(peak_area_1 > 0 ~ 1),
         peak_area_2 = case_when(peak_area_2 > 0 ~ 1),
         peak_area_3 = case_when(peak_area_3 > 0 ~ 1),
         acquisition_count = peak_area_1 + peak_area_2 + peak_area_3,
         acquisition_KEEP = acquisition_count >= 2) %>% 
  filter(acquisition_KEEP) %>% 
  dplyr::select(-c(contains("peak_area"), contains("acquisition")))


```


#### 3 replicates

```{r}
## Now, we only select molecules that were identified in 2/3 of the total reps

max_replicates = 
  dat_acq %>% 
  dplyr::select(sample_name, Proposal_ID, Sampling_Set, Core_Section, Rep) %>% 
  distinct() %>% 
  group_by(sample_name, Proposal_ID, Sampling_Set, Core_Section) %>% 
  dplyr::summarise(total_reps = n()) 


dat_reps = 
  dat_acq %>% 
  left_join(max_replicates) %>% 
  group_by(Proposal_ID, Sampling_Set, Core_Section, molecular_formula) %>% 
  dplyr::mutate(peak_reps = n()) %>%
  ungroup() %>% 
  mutate(KEEP = peak_reps >= (2/3) * total_reps) %>% 
  filter(KEEP) %>% 
  dplyr::select(-KEEP)

dat_reps_keep = 
  dat_reps %>% 
  dplyr::select(-c(Rep, total_reps, peak_reps)) %>% 
  distinct()

```

This is the list of all the peaks "present" (identified) in our samples.

Now, combine this file with the `mol` file we generated above.


```{r}
icr_processed = 
  dat_reps_keep %>% 
  left_join(mol)

names(icr_processed)
```

---- 

# Van Krevelen Plots and Molecular Classes


## VK Domains

```{r, fig.height=12, fig.width=17}
vk_domains = 
  icr_processed %>% 
  dplyr::select(HC, OC, Class1, Class2, Class3)

vk1 = 
  vk_domains %>% 
  ggplot(aes(x = OC, y = HC, color = Class1))+
  geom_point()

vk2 = 
  vk_domains %>% 
  ggplot(aes(x = OC, y = HC, color = Class2))+
  geom_point()

vk3 = 
  vk_domains %>% 
  ggplot(aes(x = OC, y = HC, color = Class3))+
  geom_point()

cowplot::plot_grid(vk1, vk2, vk3)
```


## VK Patterns in samples

```{r}

icr_processed %>% 
  ggplot(aes(x = OC, y = HC))+
  geom_point(size = 0.5)+
  facet_wrap(~ sample_name)

```

## unique peaks

top vs. bottom

```{r, fig.width=12}

unique_top = 
  icr_processed %>% 
  group_by(molecular_formula, Proposal_ID) %>% 
  dplyr::mutate(count = n()) %>% 
  ungroup()

unique_top %>% 
  filter(count == 1) %>% 
  ggplot(aes(x = OC, y = HC, color = Core_Section))+
  geom_point(size = 2)+
  facet_wrap(~ Proposal_ID + Sampling_Set)  

```


comparing sites

```{r}

unique_site = 
  icr_processed %>% 
  filter(Core_Section == "TOP") %>% 
  group_by(molecular_formula) %>% 
  dplyr::mutate(count = n())

unique_site %>% 
  filter(count == 1) %>% 
  ggplot(aes(x = OC, y = HC, color = Proposal_ID))+
  geom_point(size = 2)+
  stat_ellipse(level = 0.90, linewidth = 1, aes(group = Proposal_ID), color = "black")

```


```{r}

icr_processed %>% 
  ggplot(aes(x = NOSC, color = Core_Section))+
  geom_histogram(position = "identity", fill = NA, linewidth = 1)+
  facet_wrap(~Proposal_ID)

icr_processed %>% 
  ggplot(aes(x = calculated_m_z, color = Core_Section))+
  geom_histogram(position = "identity", fill = NA, linewidth = 1)+
#  geom_density(linewidth = 1)+
  facet_wrap(~Proposal_ID)

```


### relative abundance

```{r}

relabund = 
  icr_processed %>% 
  group_by(Proposal_ID, Sampling_Set, Core_Section, sample_name, Class2) %>% 
  dplyr::summarise(count = n()) %>% 
  group_by(Proposal_ID, Sampling_Set, Core_Section, sample_name) %>% 
  dplyr::mutate(total = sum(count),
                relabund = 100 * count/total) %>% 
  ungroup()

relabund %>% 
  ggplot(aes(x = Core_Section, y = relabund, fill = Class2)) +
  geom_bar(stat = "identity")+
  facet_wrap(~Proposal_ID)

```

